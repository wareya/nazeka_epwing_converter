#![allow(clippy::ptr_arg)]

use super::jsondict::*;
use super::epwing::*;

use regex::Regex;
use lazy_static::*;

fn shinmeikai_heading_rendering(reading: &String, spellings : &Vec<String>) -> String
{
    let mut out = reading.clone();
    for spelling in spellings
    {
        if spelling.as_str() != ""
        {
            out = format!("{}ã€{}ã€‘", out, spelling);
        }
    }
    out
}

fn shinmeikai_strip_second_heading(definition : &mut Vec<String>, reading: &String, spellings : &Vec<String>)
{
    if !definition.is_empty()
    {
        definition[0] = definition[0].replacen(&shinmeikai_heading_rendering(&reading, &spellings), "Info: ", 1);
        if definition[0].as_str() == "Info: "
        {
            definition.remove(0);
        }
    }
}

fn shinmeikai_strip_examples(definition : &mut Vec<String>)
{
    let re = Regex::new("^ã€Œ.*ã€$").unwrap();
    let mut i = 0;
    while i < definition.len()
    {
        if re.is_match(&definition[i])
        {
            definition.remove(i);
        }
        else
        {
            i += 1;
        }
    }
}

pub (crate) fn convert_shinmeikai_5(entry : &EpwingEntry) -> Option<JsonEntry>
{
    if let (Some(mut definition), Some((reading, spellings))) = (shinmeikai_body_converter(&entry.text), shinmeikai_heading_converter(&entry.heading))
    {
        shinmeikai_strip_second_heading(&mut definition, &reading, &spellings);
        Some(JsonEntry{r:reading, s:spellings, l:definition})
    }
    else
    {
        None
    }
}

pub (crate) fn convert_shinmeikai_5_no_examples(entry : &EpwingEntry) -> Option<JsonEntry>
{
    if let (Some(mut definition), Some((reading, spellings))) = (shinmeikai_body_converter(&entry.text), shinmeikai_heading_converter(&entry.heading))
    {
        shinmeikai_strip_second_heading(&mut definition, &reading, &spellings);
        shinmeikai_strip_examples(&mut definition);
        Some(JsonEntry{r:reading, s:spellings, l:definition})
    }
    else
    {
        None
    }
}

fn shinmeikai_is_kana_toc(list : &Vec<String>) -> bool
{
    let re = Regex::new("^ãƒ».*ã€œ.*$").unwrap();
    if list.len() > 2
    {
        for entry in &list[2..]
        {
            if !re.is_match(entry)
            {
                return false;
            }
        }
        return true;
    }
    false
}
fn shinmeikai_is_kana_kanji_ref(list : &Vec<String>) -> bool
{
    let re = Regex::new("^ï¼ˆ.*ï¼‰[ ]*â†’ã€å­—éŸ³èªã®é€ èªæˆåˆ†ã€‘$").unwrap();
    if list.len() == 2
    {
        return re.is_match(&list[1]);
    }
    false
}

fn shinmeikai_body_converter(body : &String) -> Option<Vec<String>>
{
    let body = shinmeikai_gaiji_fixer(body.as_str());
    
    let mut entries : Vec<String> = body.trim().split('\n').map(|s| s.to_string()).collect();
    let definition = entries.drain(..).map(|mut s| s.drain(..).collect()).collect();
    
    if shinmeikai_is_kana_toc(&definition) || shinmeikai_is_kana_kanji_ref(&definition)
    {
        return None;
    }
    
    Some(definition)
}

fn shinmeikai_heading_converter(heading : &String) -> Option<(String, Vec<String>)>
{
    let heading = shinmeikai_gaiji_fixer(heading.as_str());
    
    let mut reading = vec!();
    let mut spellings = vec!();
    let heading_chars = heading.chars().collect::<Vec<char>>();
    let mut i = 0;
    let mut mode = 0; // 0 : reading; 1 : spelling; 2 : after spelling
    while i < heading_chars.len()
    {
        match mode
        {
            0 =>
            {
                match heading_chars[i]
                {
                    'ï¼»' => return None, // kanji entry
                    'ã€' =>
                    {
                        spellings.push(vec!());
                        mode = 1;
                    }
                    ' ' | '[' => break,
                    'ã€‘' => panic!("unknown state"),
                    c => reading.push(c)
                }
            }
            1 =>
            {
                match heading_chars[i]
                {
                    'ã€‘' => mode = 2,
                    '[' | 'ã€' | 'ï¼»' | ' ' => panic!("unknown state"),
                    c => spellings.last_mut().unwrap().push(c),
                }
            }
            2 =>
            {
                match heading_chars[i]
                {
                    'ã€' =>
                    {
                        spellings.push(vec!());
                        mode = 1;
                    }
                    _ => break
                }
            }
            _ => panic!("unknown state")
        }
        i += 1;
    }
    let reading = reading.drain(..).collect();
    let mut spellings : Vec<String> = spellings.drain(..).map(|mut s| s.drain(..).collect()).collect();
    if spellings.is_empty()
    {
        spellings.push("".to_string());
    }
    Some((reading, spellings))
}

fn shinmeikai_gaiji_fixer(text : &str) -> String
{
    let mut text = text.to_string();
    
    for mapping in GAIJI_MAPPING.iter()
    {
        text = text.replace(mapping.0, mapping.1);
    }
    text
}

lazy_static! {
    static ref GAIJI_MAPPING : Vec<(&'static str, &'static str)> = vec!(
      ("{{n_41258}}", "Â©"),
      ("{{n_41285}}", "Ã„"),
      ("{{n_41286}}", "Ã…"),
      ("{{n_41290}}", "Ã‰"),
      ("{{n_41312}}", "ÃŸ"),
      ("{{n_41313}}", "Ã "),
      ("{{n_41314}}", "Ã¡"),
      ("{{n_41315}}", "Ã¢"),
      ("{{n_41316}}", "Ã£"),
      ("{{n_41317}}", "Ã¤"),
      ("{{n_41318}}", "Ã¥"),
      ("{{n_41320}}", "Ã§"),
      ("{{n_41321}}", "Ã¨"),
      ("{{n_41322}}", "Ã©"),
      ("{{n_41323}}", "Ãª"),
      ("{{n_41324}}", "Ã«"),
      ("{{n_41326}}", "Ã­"),
      ("{{n_41327}}", "Ã®"),
      ("{{n_41328}}", "Ã¯"),
      ("{{n_41330}}", "Ã±"),
      ("{{n_41332}}", "Ã³"),
      ("{{n_41333}}", "Ã´"),
      ("{{n_41335}}", "Ã¶"),
      ("{{n_41340}}", "Ã»"),
      ("{{n_41341}}", "Ã¼"),
      ("{{n_41508}}", "Ä"),
      ("{{n_41526}}", "Ä“"),
      ("{{n_41550}}", "Ä«"),
      ("{{n_41584}}", "Å"),
      ("{{n_41590}}", "Å“"),
      ("{{w_45089}}", "å²"),
      ("{{w_45090}}", "å‘"),
      ("{{w_45091}}", "å˜»"),
      ("{{w_45092}}", "å™¯"),
      ("{{w_45093}}", "åœ®"),
      ("{{w_45094}}", "å£”"),
      ("{{w_45095}}", "å½€"),
      ("{{w_45096}}", "æŒ˜"),
      ("{{w_45097}}", "æ‘¹"),
      ("{{w_45098}}", "æ”™"),
      ("{{w_45099}}", "è…Š"),
      ("{{w_45100}}", "æŸ¹"),
      ("{{w_45101}}", "æ˜"),
      ("{{w_45102}}", "æ»"),
      ("{{w_45103}}", "æ¢›"),
      ("{{w_45104}}", "æ£°"),
      ("{{w_45105}}", "æ­¥"),
      ("{{w_45106}}", "æ±´"),
      ("{{w_45107}}", "æ´"),
      ("{{w_45108}}", "ç‚·"),
      ("{{w_45109}}", "ç„®"),
      ("{{w_45110}}", "ç‰“"),
      ("{{w_45111}}", "çŠ›"),
      ("{{w_45112}}", "ç‹€"),
      ("{{w_45113}}", "ç"),
      ("{{w_45114}}", "ç•"),
      ("{{w_45115}}", "ç—€"),
      ("{{w_45116}}", "ç—¤"),
      ("{{w_45117}}", "ç˜­"),
      ("{{w_45118}}", "çŸ»"),
      ("{{w_45119}}", "ç °"),
      ("{{w_45120}}", "ç¡®"),
      ("{{w_45121}}", "ç¡¼"),
      ("{{w_45122}}", "çª "),
      ("{{w_45123}}", "ç­©"),
      ("{{w_45124}}", "ç®™"),
      ("{{w_45125}}", "ç°"),
      ("{{w_45126}}", "ç³—"),
      ("{{w_45127}}", "ç³"),
      ("{{w_45128}}", "çµ“"),
      ("{{w_45129}}", "ç¸•"),
      ("{{w_45130}}", "ç¸ "),
      ("{{w_45131}}", "ï©›"),
      ("{{w_45132}}", "è€º"),
      ("{{w_45133}}", "ï©Ÿ"),
      ("{{w_45134}}", "è•"),
      ("{{w_45135}}", "è–"),
      ("{{w_45136}}", "ï¨Ÿ"),
      ("{{w_45139}}", "è™¬"),
      ("{{w_45140}}", "èœ‹"),
      ("{{w_45141}}", "èˆ"),
      ("{{w_45142}}", "è­"),
      ("{{w_45143}}", "è¢ª"),
      ("{{w_45144}}", "è£±"),
      ("{{w_45145}}", "è¤Š"),
      ("{{w_45146}}", "è¦¯"),
      ("{{w_45147}}", "è·—"),
      ("{{w_45148}}", "è¸ "),
      ("{{w_45149}}", "â»Œ"),
      ("{{w_45150}}", "é‚ƒ"),
      ("{{w_45151}}", "é‚ˆ"),
      ("{{w_45152}}", "é…´"),
      ("{{w_45153}}", "é†"),
      ("{{w_45154}}", "é‡ƒ"),
      ("{{w_45155}}", "é”"),
      ("{{w_45156}}", "éŸ›"),
      ("{{w_45157}}", "é«¤"),
      ("{{w_45158}}", "é­"),
      ("{{w_45159}}", "é®"),
      ("{{w_45160}}", "éº¼"),
      ("{{w_45161}}", "é¼¯"),
      ("{{w_45162}}", "æ½­"),
      ("{{w_45163}}", "è½"),
      ("{{w_45164}}", "æ¥"),
      ("{{w_45165}}", "æ¥¤"),
      ("{{w_45166}}", "ä¸°"),
      ("{{w_45167}}", "åš®"),
      ("{{w_45169}}", "ç—"),
      ("{{w_45175}}", "<unencoded>"),
      ("{{w_45176}}", "å—©"),
      ("{{w_45177}}", "å™‰"),
      ("{{w_45178}}", "å›»"),
      ("{{w_45179}}", "ä¨”"),
      ("{{w_45180}}", "äº—"),
      ("{{w_45181}}", "çµ"),
      ("{{w_45182}}", "çŠ±"),
      ("{{w_45345}}", "æ½¢"),
      ("{{w_45346}}", "è˜˜"),
      ("{{w_45347}}", "è”²"),
      ("{{w_45348}}", "è”"),
      ("{{w_45349}}", "è•ˆ"),
      ("{{w_45350}}", "è§"),
      ("{{w_45351}}", "è‹†"),
      ("{{w_45352}}", "æƒ"),
      ("{{w_45353}}", "æ€³"),
      ("{{w_45354}}", "è†"),
      ("{{w_45355}}", "æ¥‰"),
      ("{{w_45356}}", "é€¹"),
      ("{{w_45358}}", "ç§Š"),
      ("{{w_45359}}", "ç®¶"),
      ("{{w_45360}}", "ç°º"),
      ("{{w_45361}}", "ç±¡"),
      ("{{w_45362}}", "ç®µ"),
      ("{{w_45363}}", "ç¯¼"),
      ("{{w_45364}}", "éµƒ"),
      ("{{w_45365}}", "é´¹"),
      ("{{w_45366}}", "<unencoded>"),
      ("{{w_45367}}", "è›š"),
      ("{{w_45368}}", "è °"),
      ("{{w_45369}}", "èŸ«"),
      ("{{w_45370}}", "é‡„"),
      ("{{w_45371}}", "é†"),
      ("{{w_45372}}", "é‰"),
      ("{{w_45374}}", "ã€³"),
      ("{{w_45375}}", "ã€µ"),
      ("{{w_45396}}", "ã‚œ"),
      ("{{w_45397}}", "ï¼"),
      ("{{w_45398}}", "ï¼"),
      ("{{w_45399}}", "â€¼"),
      ("{{w_45400}}", "<unencoded>"),
      ("{{w_45401}}", "ã€±"),
      ("{{w_45403}}", "â—"),
      ("{{w_45404}}", "â—‹"),
      ("{{w_45405}}", "ï¹…"),
      ("{{w_45406}}", "ã€"),
      ("{{w_45407}}", "ã€"),
      ("{{w_45411}}", "ã€Ÿ"),
      ("{{w_45415}}", "<unencoded>"),
      ("{{w_45416}}", "<unencoded>"),
      ("{{w_45417}}", "âˆ“"),
      ("{{w_45419}}", "â‰ "),
      ("{{w_45420}}", "â‰“"),
      ("{{w_45421}}", "âˆš"),
      ("{{w_45422}}", "ã€€"),
      ("{{w_45423}}", "2"),
      ("{{w_45424}}", "5"),
      ("{{w_45425}}", "â„‰"),
      ("{{w_45427}}", "ãœ"),
      ("{{w_45428}}", "ã"),
      ("{{w_45429}}", "lb"),
      ("{{w_45430}}", "ã„"),
      ("{{w_45431}}", "ã¾"),
      ("{{w_45432}}", "ã€½"),
      ("{{w_45434}}", "ã€„"),
      ("{{w_45435}}", "â™ "),
      ("{{w_45436}}", "â™¥"),
      ("{{w_45610}}", "ã€°"),
      ("{{w_45611}}", "â”ˆ"),
      ("{{w_45618}}", "â€œ"),
      ("{{w_45619}}", "â€"),
      ("{{w_45620}}", "ï¬€"),
      ("{{w_45624}}", "â„«"),
      ("{{w_45654}}", "Î©"),
      ("{{w_45659}}", "Âµ"),
      ("{{w_45661}}", "Ï€"),
      ("{{w_45662}}", "Âµc"),
      ("{{w_45667}}", "ã€˜"),
      ("{{w_45669}}", "ã€™"),
      ("{{w_45670}}", "ğ †¢"),
      ("{{w_45673}}", "Î”"),
      ("{{w_45674}}", "è•º"),
      ("{{w_45675}}", "å™¦"),
      ("{{w_45676}}", "å”³"),
      ("{{w_45678}}", "å¢"),
      ("{{w_45679}}", "åŸµ"),
      ("{{w_45680}}", "å¢"),
      ("{{w_45681}}", "æ¢"),
      ("{{w_45683}}", "æ¹‘"),
      ("{{w_45684}}", "æ¿¹"),
      ("{{w_45685}}", "æ¡›"),
      ("{{w_45686}}", "æ¢£"),
      ("{{w_45687}}", "æ¨"),
      ("{{w_45688}}", "æ¢»"),
      ("{{w_45689}}", "æ©"),
      ("{{w_45690}}", "æ¢˜"),
      ("{{w_45691}}", "æ¢²"),
      ("{{w_45692}}", "æ©…"),
      ("{{w_45693}}", "æª‰"),
      ("{{w_45694}}", "æ¨"),
      ("{{w_45857}}", "æ¢‚"),
      ("{{w_45858}}", "æ¡€"),
      ("{{w_45859}}", "èƒ¼"),
      ("{{w_45860}}", "è…­"),
      ("{{w_45861}}", "èƒ³"),
      ("{{w_45862}}", "é°§"),
      ("{{w_45863}}", "ç«"),
      ("{{w_45864}}", "ç°"),
      ("{{w_45865}}", "ç‘‡"),
      ("{{w_45866}}", "éº¬"),
      ("{{w_45867}}", "ç¡‘"),
      ("{{w_45868}}", "ç¡¨"),
      ("{{w_45869}}", "ç£²"),
      ("{{w_45870}}", "è£°"),
      ("{{w_45871}}", "è¢˜"),
      ("{{w_45872}}", "ç¯Š"),
      ("{{w_45873}}", "ç¬§"),
      ("{{w_45874}}", "ç°"),
      ("{{w_45875}}", "ç¬„"),
      ("{{w_45876}}", "ç°"),
      ("{{w_45877}}", "ç±†"),
      ("{{w_45878}}", "ç­¬"),
      ("{{w_45879}}", "ç±™"),
      ("{{w_45880}}", "ç¬­"),
      ("{{w_45881}}", "ç²"),
      ("{{w_45882}}", "ç³ˆ"),
      ("{{w_45883}}", "ç´‡"),
      ("{{w_45884}}", "èŸ–"),
      ("{{w_45885}}", "èš¸"),
      ("{{w_45886}}", "èœ“"),
      ("{{w_45887}}", "èœ¾"),
      ("{{w_45888}}", "è‡"),
      ("{{w_45889}}", "è "),
      ("{{w_45890}}", "éˆ¸"),
      ("{{w_45891}}", "éŒ‘"),
      ("{{w_45892}}", "éº"),
      ("{{w_45893}}", "é°"),
      ("{{w_45894}}", "é"),
      ("{{w_45896}}", "é­³"),
      ("{{w_45897}}", "é¯"),
      ("{{w_45898}}", "é®„"),
      ("{{w_45899}}", "é±©"),
      ("{{w_45900}}", "é¯"),
      ("{{w_45901}}", "é¯‡"),
      ("{{w_45902}}", "é®"),
      ("{{w_45903}}", "é°–"),
      ("{{w_45904}}", "é®¸"),
      ("{{w_45905}}", "é¯·"),
      ("{{w_45906}}", "é­¬"),
      ("{{w_45907}}", "é±"),
      ("{{w_45908}}", "é±"),
      ("{{w_45909}}", "é±“"),
      ("{{w_45910}}", "å­’"),
      ("{{w_45911}}", "ä¹ "),
      ("{{w_45912}}", "ä¹‰"),
      ("{{w_45913}}", "ã•"),
      ("{{w_45914}}", "å´"),
      ("{{w_45916}}", "å°©"),
      ("{{w_45917}}", "é‚Œ"),
      ("{{w_45919}}", "ç¦»"),
      ("{{w_45920}}", "è ƒ"),
      ("{{w_45921}}", "åŠ„"),
      ("{{w_45923}}", "æ„’"),
      ("{{w_45924}}", "å½”"),
      ("{{w_45925}}", "å½½"),
      ("{{w_45926}}", "é‚™"),
      ("{{w_45927}}", "è²›"),
      ("{{w_45928}}", "æ”²"),
      ("{{w_45930}}", "ç‡„"),
      ("{{w_45931}}", "ğ£´´"),
      ("{{w_45932}}", "å¿©"),
      ("{{w_45933}}", "ç–’"),
      ("{{w_45934}}", "ç™¤"),
      ("{{w_45935}}", "çœ´"),
      ("{{w_45936}}", "çŸ•"),
      ("{{w_45937}}", "çº"),
      ("{{w_45938}}", "æ¯—"),
      ("{{w_45939}}", "ğ¥±"),
      ("{{w_45940}}", "ç¨­"),
      ("{{w_45941}}", "çš"),
      ("{{w_45942}}", "è€®"),
      ("{{w_45943}}", "ç¿©"),
      ("{{w_45944}}", "èˆ¢"),
      ("{{w_45945}}", "è‰˜"),
      ("{{w_45946}}", "é†º"),
      ("{{w_45947}}", "è·‘"),
      ("{{w_45948}}", "èº‡"),
      ("{{w_45950}}", "è«›"),
      ("{{w_46113}}", "èº»"),
      ("{{w_46114}}", "é¤›"),
      ("{{w_46115}}", "é¡¬"),
      ("{{w_46116}}", "éª¶"),
      ("{{w_46117}}", "é¶"),
      ("{{w_46118}}", "é´²"),
      ("{{w_46119}}", "éµ¼"),
      ("{{w_46120}}", "é¼¹"),
      ("{{w_46121}}", "é¸Š"),
      ("{{w_46122}}", "é·‰"),
      ("{{w_46123}}", "éµ‡"),
      ("{{w_46124}}", "ğ¦¼ "),
      ("{{w_46125}}", "ä•Ÿ"),
      ("{{w_46126}}", "å¼"),
      ("{{w_46127}}", "æ¡²"),
      ("{{w_46128}}", "ç¥›"),
      ("{{w_46129}}", "è›¼"),
      ("{{w_46130}}", "ç˜€"),
      ("{{w_46131}}", "ãš‘"),
      ("{{w_46132}}", "<unencoded>"),
      ("{{w_46133}}", "é¯¸"),
      ("{{w_46134}}", "é¯¼"),
      ("{{w_46135}}", "ä±Œ"),
      ("{{w_46136}}", "ğ©¸½"),
      ("{{w_46137}}", "é±²"),
      ("{{w_46138}}", "ğ©ºŠ"),
      ("{{w_46139}}", "é±—"),
      ("{{w_46140}}", "éº"),
      ("{{w_46141}}", "è‰¹"),
      ("{{w_46142}}", "ğ¥«—"),
      ("{{w_46143}}", "ğ ƒ‹"),
      ("{{w_46144}}", "ä¸†"),
      ("{{w_46170}}", "<unencoded>"),
      ("{{w_46171}}", "ğ›…"),
      ("{{w_46183}}", "â‡’"),
      ("{{w_46184}}", "â‡”"),
      ("{{w_46386}}", "á¹ƒ"),
      ("{{w_46387}}", "Å›"),
      ("{{w_46388}}", "Å¡"),
      ("{{w_46389}}", "È³"),
      ("{{w_46390}}", "<unencoded>"),
      ("{{w_46391}}", "ğªœˆ"),
      ("{{w_46395}}", "ğ„"),
      ("{{w_46396}}", "<unencoded>"),
      ("{{w_46397}}", "ğ›‚Œ"),
      ("{{w_46398}}", "ğ›‚¦"),
      ("{{w_46399}}", "â™©"),
      ("{{w_46400}}", "ğ…"),
      ("{{w_46401}}", "â›©ï¸"),
      ("{{w_46402}}", "â™®"),
      ("{{w_46403}}", "ã‚"),
      ("{{w_46404}}", "ğ›€¸"),
      ("{{w_46405}}", "âœ“"),
      ("{{w_46406}}", "<unencoded>"),
      ("{{w_46407}}", "å"),
      ("{{w_46414}}", "ã‡”"),
      ("{{w_46431}}", "â"),
      ("{{w_46432}}", "â‘"),
    );
}
